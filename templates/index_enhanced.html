<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîé Backtest Grid Search - Enhanced Progress</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .status-bar {
            background: #f8f9fa;
            padding: 15px;
            border-bottom: 2px solid #e9ecef;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 500;
        }
        
        .status-ready {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-processing {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .status-complete {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .progress-section {
            background: #f8f9fa;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            border-left: 4px solid #007bff;
            display: none;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #007bff, #0056b3);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .quick-summary {
            background: #e8f5e8;
            border: 2px solid #4caf50;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            display: none;
        }
        
        .parameter-suggestion {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            display: none;
        }
        
        .suggestion-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 15px 0;
        }
        
        .suggestion-explanation {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
        
        .efficiency-metrics {
            background: #d4edda;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #28a745;
        }
        
        .form-section {
            background: #f8f9fa;
            padding: 25px;
            margin: 20px 0;
            border-radius: 10px;
            border-left: 4px solid #28a745;
        }
        
        .file-upload {
            border: 2px dashed #007bff;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            margin: 15px 0;
            transition: all 0.3s ease;
        }
        
        .file-upload:hover {
            border-color: #0056b3;
            background: #f8f9fa;
        }
        
        .btn {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px 5px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,123,255,0.3);
        }
        
        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-suggest {
            background: linear-gradient(135deg, #28a745, #1e7e34);
            margin-left: 10px;
        }
        
        .btn-suggest:hover {
            box-shadow: 0 5px 15px rgba(40,167,69,0.3);
        }
        
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: 500;
        }
        
        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .timer {
            font-family: 'Courier New', monospace;
            font-size: 1.2em;
            color: #007bff;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîé Backtest Grid Search - Enhanced</h1>
            <p>T·ªëi ∆∞u Stop Loss v·ªõi Progress Tracking</p>
            
            <!-- Navigation Menu -->
            <div style="margin-top: 20px; display: flex; justify-content: center; gap: 15px; flex-wrap: wrap;">
                <a href="/" style="color: white; text-decoration: none; padding: 8px 16px; background: rgba(255,255,255,0.2); border-radius: 20px; transition: all 0.3s;">
                    üè† Home
                </a>
                <a href="/batch" style="color: white; text-decoration: none; padding: 8px 16px; background: rgba(255,255,255,0.2); border-radius: 20px; transition: all 0.3s;">
                    üìä Batch Processing
                </a>
                <a href="/compare" style="color: white; text-decoration: none; padding: 8px 16px; background: rgba(255,255,255,0.2); border-radius: 20px; transition: all 0.3s;">
                    üîç Compare Results
                </a>
                <a href="/analytics" style="color: white; text-decoration: none; padding: 8px 16px; background: rgba(255,255,255,0.2); border-radius: 20px; transition: all 0.3s;">
                    üìà Analytics
                </a>
            </div>
        </div>
        
        <!-- Status Bar -->
        <div class="status-bar">
            <div id="statusIndicator" class="status-indicator status-ready">
                <span id="statusIcon">‚úÖ</span>
                <span id="statusText">S·∫µn s√†ng - Upload files ƒë·ªÉ b·∫Øt ƒë·∫ßu</span>
            </div>
            <div id="timerDisplay" class="timer" style="display: none;">
                ‚è±Ô∏è <span id="elapsed">00:00</span>
            </div>
        </div>
        
        <!-- Progress Section -->
        <div id="progressSection" class="progress-section">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <strong id="progressTitle">ƒêang x·ª≠ l√Ω...</strong>
                <span id="progressPercent">0%</span>
            </div>
            <div class="progress-bar">
                <div id="progressFill" class="progress-fill"></div>
            </div>
            <div id="progressDetail" style="font-size: 0.9em; color: #666; margin-top: 5px;">
                ƒêang kh·ªüi t·∫°o...
            </div>
        </div>
        
        <!-- Quick Summary -->
        <div id="quickSummary" class="quick-summary">
            <h3>üìä T·ªïng k·∫øt nhanh t·ª´ d·ªØ li·ªáu g·ªëc</h3>
            <div id="summaryContent"></div>
        </div>
        
        <!-- Smart Parameter Suggestion Results -->
        <div id="parameterSuggestion" class="parameter-suggestion" style="display: none;">
            <h3>üéØ G·ª£i √Ω Th√¥ng s·ªë Th√¥ng minh</h3>
            <div id="suggestionContent"></div>
        </div>
        
        <!-- Upload Section -->
        <div class="form-section">
            <h3>üìÅ Upload Files</h3>
            <div class="file-upload">
                <input type="file" id="tradeFile" accept=".csv" style="margin: 10px;">
                <label for="tradeFile">Trade CSV File</label>
            </div>
            <div class="file-upload">
                <input type="file" id="candleFile" accept=".csv" style="margin: 10px;">
                <label for="candleFile">Candle CSV File</label>
            </div>
            <button id="quickSummaryBtn" class="btn" onclick="getQuickSummary()">
                üöÄ Xem T·ªïng k·∫øt Nhanh
            </button>
            <button id="suggestParamsBtn" class="btn btn-suggest" onclick="suggestParameters()">
                üéØ G·ª£i √Ω D·∫£i Th√¥ng s·ªë Qu√©t
            </button>
        </div>
        
        <!-- Trade Selection -->
        <div class="form-section">
            <h3>üéØ Ch·ªçn l·ªánh ƒë·ªÉ test</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                <div>
                    <label>T·ª´ l·ªánh s·ªë:</label>
                    <input type="number" id="startTrade" value="1" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                    <small style="color: #666;">S·ªë √¢m = t·ª´ cu·ªëi (-50 = 50 l·ªánh cu·ªëi)</small>
                </div>
                <div>
                    <label>S·ªë l∆∞·ª£ng t·ªëi ƒëa:</label>
                    <input type="number" id="maxTrades" value="0" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                    <small style="color: #666;">0 = kh√¥ng gi·ªõi h·∫°n</small>
                </div>
                <div>
                    <label>Ch·∫ø ƒë·ªô ch·ªçn:</label>
                    <select id="tradeSelectionMode" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                        <option value="sequence">Theo th·ª© t·ª±</option>
                        <option value="time">Theo th·ªùi gian</option>
                        <option value="random">Ng·∫´u nhi√™n</option>
                    </select>
                </div>
            </div>
        </div>
        
        <!-- Parameters -->
        <div class="form-section">
            <h3>‚öôÔ∏è Tham s·ªë t·ªëi ∆∞u</h3>
            <!-- Ch·ªçn th√¥ng s·ªë c·∫ßn t·ªëi ∆∞u -->
            <div style="margin-bottom: 20px;">
                <label><strong>Ch·ªçn th√¥ng s·ªë c·∫ßn t·ªëi ∆∞u:</strong></label><br>
                <label style="margin-right: 15px;"><input type="checkbox" id="optimizeSL" checked> Stop Loss (SL)</label>
                <label style="margin-right: 15px;"><input type="checkbox" id="optimizeBE" checked> Break Even (BE)</label>
                <label style="margin-right: 15px;"><input type="checkbox" id="optimizeTS" checked> Trailing Stop (TS)</label>
                <span style="font-size: 12px; color: #666; margin-left: 10px;">(B·ªè ch·ªçn ƒë·ªÉ kh√¥ng t·ªëi ∆∞u/th·ª≠ nghi·ªám th√¥ng s·ªë ƒë√≥)</span>
            </div>
            
            <!-- SL Parameters -->
            <div style="margin-bottom: 20px;">
                <h4 style="color: #dc3545;">üõë Stop Loss (SL)</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                    <div>
                        <label>SL Min (%):</label>
                        <input type="number" id="slMin" value="0.5" step="0.1" style="width: 100%; padding: 8px;">
                    </div>
                    <div>
                        <label>SL Max (%):</label>
                        <input type="number" id="slMax" value="3.0" step="0.1" style="width: 100%; padding: 8px;">
                    </div>
                    <div>
                        <label>SL Step (%):</label>
                        <input type="number" id="slStep" value="0.5" step="0.1" style="width: 100%; padding: 8px;">
                    </div>
                </div>
            </div>
            
            <!-- BE Parameters -->
            <div style="margin-bottom: 20px;">
                <h4 style="color: #28a745;">üíö Break Even (BE)</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                    <div>
                        <label>BE Min (%):</label>
                        <input type="number" id="beMin" value="0.5" step="0.1" style="width: 100%; padding: 8px;">
                    </div>
                    <div>
                        <label>BE Max (%):</label>
                        <input type="number" id="beMax" value="2.0" step="0.1" style="width: 100%; padding: 8px;">
                    </div>
                    <div>
                        <label>BE Step (%):</label>
                        <input type="number" id="beStep" value="0.5" step="0.1" style="width: 100%; padding: 8px;">
                    </div>
                </div>
            </div>
            
            <!-- TS Parameters -->
            <div style="margin-bottom: 20px;">
                <h4 style="color: #007bff;">üìà Trailing Stop (TS)</h4>
                <div style="margin-bottom: 10px;">
                    <strong>TS Trigger:</strong>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                        <div>
                            <label>TS Trig Min (%):</label>
                            <input type="number" id="tsTrigMin" value="0.5" step="0.1" style="width: 100%; padding: 8px;">
                        </div>
                        <div>
                            <label>TS Trig Max (%):</label>
                            <input type="number" id="tsTrigMax" value="3.0" step="0.1" style="width: 100%; padding: 8px;">
                        </div>
                        <div>
                            <label>TS Trig Step (%):</label>
                            <input type="number" id="tsTrigStep" value="0.5" step="0.1" style="width: 100%; padding: 8px;">
                        </div>
                    </div>
                </div>
                <div>
                    <strong>TS Step:</strong>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                        <div>
                            <label>TS Step Min (%):</label>
                            <input type="number" id="tsStepMin" value="0.5" step="0.1" style="width: 100%; padding: 8px;">
                        </div>
                        <div>
                            <label>TS Step Max (%):</label>
                            <input type="number" id="tsStepMax" value="1.0" step="0.1" style="width: 100%; padding: 8px;">
                        </div>
                        <div>
                            <label>TS Step Step (%):</label>
                            <input type="number" id="tsStepStep" value="0.2" step="0.1" style="width: 100%; padding: 8px;">
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Optimization Type -->
            <div>
                <label><strong>T·ªëi ∆∞u theo:</strong></label>
                <select id="optType" style="width: 200px; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                    <option value="pnl">Total PnL</option>
                    <option value="winrate">Win Rate</option>
                    <option value="pf">Profit Factor</option>
                    <option value="sharpe">Sharpe Ratio</option>
                    <option value="recovery">Recovery Factor</option>
                    <option value="drawdown">Min Drawdown</option>
                </select>
            </div>
            
            <!-- Advanced Mode Option -->
            <div style="margin-top: 15px;">
                <label style="display: flex; align-items: center; gap: 5px;">
                    <input type="checkbox" id="forceAdvanced" style="transform: scale(1.2);">
                    <strong>Force Advanced Mode</strong>
                    <span style="font-size: 12px; color: #666; margin-left: 10px;">
                        (100K ‚Üí 1M combinations limit. C√≥ th·ªÉ ch·∫≠m v·ªõi d·∫£i r·ªông!)
                    </span>
                </label>
            </div>
            
            <!-- Combinations Counter -->
            <div id="combinationsCounter" style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px; font-size: 14px;">
                <strong>T·ªïng s·ªë combinations: </strong>
                <span id="totalCombinations" style="color: #007bff; font-weight: bold;">0</span>
                <br>
                <span id="combinationsStatus" style="font-size: 12px; color: #666;"></span>
            </div>
        </div>
        
        <!-- New Method Selection Section -->
        <div class="form-section">
            <h3>‚öôÔ∏è Ch·ªçn Ph∆∞∆°ng Ph√°p T·ªëi ∆Øu</h3>
            <div class="form-group">
                <label for="method_type"><b>Ph∆∞∆°ng ph√°p t·ªëi ∆∞u:</b></label>
                <select name="method_type" id="method_type" class="form-control">
                    <option value="grid">Grid Search (To√†n di·ªán)</option>
                    <option value="optuna">Optuna (Nhanh)</option>
                </select>
                <small class="form-text text-muted">
                    Ch·ªçn ph∆∞∆°ng ph√°p t·ªëi ∆∞u h√≥a: <b>Grid Search</b> qu√©t to√†n b·ªô, <b>Optuna</b> t√¨m nhanh v√πng t·ªëi ∆∞u.
                </small>
            </div>
        </div>
        
        <!-- Action Buttons -->
        <div style="text-align: center; padding: 30px;">
            <button id="optimizeBtn" class="btn" onclick="startOptimization()" disabled>
                üîç B·∫Øt ƒë·∫ßu T·ªëi ∆∞u
            </button>
            <button id="cancelBtn" class="btn" onclick="cancelOperation()" style="background: #dc3545; display: none;">
                ‚ùå H·ªßy
            </button>
        </div>
        
        <!-- Results will be shown here -->
        <div id="results" style="padding: 0 40px 40px;"></div>
    </div>

    <script>
        let startTime = null;
        let timerInterval = null;
        let currentController = null;
        
        // Update status
        function updateStatus(type, text, showTimer = false) {
            const indicator = document.getElementById('statusIndicator');
            const icon = document.getElementById('statusIcon');
            const statusText = document.getElementById('statusText');
            const timerDisplay = document.getElementById('timerDisplay');
            
            // Reset classes
            indicator.className = 'status-indicator';
            
            switch(type) {
                case 'ready':
                    indicator.classList.add('status-ready');
                    icon.textContent = '‚úÖ';
                    break;
                case 'processing':
                    indicator.classList.add('status-processing');
                    icon.innerHTML = '<div class="spinner"></div>';
                    break;
                case 'complete':
                    indicator.classList.add('status-complete');
                    icon.textContent = 'üéâ';
                    break;
                case 'error':
                    indicator.classList.add('status-error');
                    icon.textContent = '‚ùå';
                    break;
            }
            
            statusText.textContent = text;
            timerDisplay.style.display = showTimer ? 'block' : 'none';
            
            if (showTimer && !timerInterval) {
                startTimer();
            } else if (!showTimer && timerInterval) {
                stopTimer();
            }
        }
        
        // Timer functions
        function startTimer() {
            startTime = Date.now();
            timerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                document.getElementById('elapsed').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }
        
        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }
        
        // Progress functions
        function showProgress(title, detail = '') {
            document.getElementById('progressSection').style.display = 'block';
            document.getElementById('progressTitle').textContent = title;
            document.getElementById('progressDetail').textContent = detail;
            setProgress(0);
        }
        
        function hideProgress() {
            document.getElementById('progressSection').style.display = 'none';
        }
        
        function setProgress(percent, detail = null) {
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressPercent').textContent = Math.round(percent) + '%';
            if (detail) {
                document.getElementById('progressDetail').textContent = detail;
            }
        }
        
        // Enable optimize button when files are selected
        document.getElementById('tradeFile').addEventListener('change', checkFiles);
        document.getElementById('candleFile').addEventListener('change', checkFiles);
        
        // Add listeners for parameter changes to update combinations count
        const parameterInputs = [
            'slMin', 'slMax', 'slStep',
            'beMin', 'beMax', 'beStep', 
            'tsTrigMin', 'tsTrigMax', 'tsTrigStep',
            'tsStepMin', 'tsStepMax', 'tsStepStep',
            'forceAdvanced'
        ];
        
        parameterInputs.forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                if (element.type === 'checkbox') {
                    element.addEventListener('change', updateCombinationsCount);
                } else {
                    element.addEventListener('input', updateCombinationsCount);
                }
            }
        });
        
        function updateCombinationsCount() {
            try {
                const slMin = parseFloat(document.getElementById('slMin').value) || 0;
                const slMax = parseFloat(document.getElementById('slMax').value) || 0;
                const slStep = parseFloat(document.getElementById('slStep').value) || 0.1;
                
                const beMin = parseFloat(document.getElementById('beMin').value) || 0;
                const beMax = parseFloat(document.getElementById('beMax').value) || 0;
                const beStep = parseFloat(document.getElementById('beStep').value) || 0.1;
                
                const tsTrigMin = parseFloat(document.getElementById('tsTrigMin').value) || 0;
                const tsTrigMax = parseFloat(document.getElementById('tsTrigMax').value) || 0;
                const tsTrigStep = parseFloat(document.getElementById('tsTrigStep').value) || 0.1;
                
                const tsStepMin = parseFloat(document.getElementById('tsStepMin').value) || 0;
                const tsStepMax = parseFloat(document.getElementById('tsStepMax').value) || 0;
                const tsStepStep = parseFloat(document.getElementById('tsStepStep').value) || 0.1;
                
                // Calculate array sizes
                const slCount = slMax > slMin ? Math.max(1, Math.round((slMax - slMin) / slStep) + 1) : 1;
                const beCount = beMax > beMin ? Math.max(1, Math.round((beMax - beMin) / beStep) + 1) : 1;
                const tsTrigCount = tsTrigMax > tsTrigMin ? Math.max(1, Math.round((tsTrigMax - tsTrigMin) / tsTrigStep) + 1) : 1;
                const tsStepCount = tsStepMax > tsStepMin ? Math.max(1, Math.round((tsStepMax - tsStepMin) / tsStepStep) + 1) : 1;
                
                const totalCombinations = slCount * beCount * tsTrigCount * tsStepCount;
                
                // Update display
                document.getElementById('totalCombinations').textContent = totalCombinations.toLocaleString();
                
                const forceAdvanced = document.getElementById('forceAdvanced').checked;
                const limit = forceAdvanced ? 1000000 : 100000;
                const statusElement = document.getElementById('combinationsStatus');
                
                if (totalCombinations <= 1000) {
                    statusElement.textContent = '‚úÖ Nhanh (‚â§1K combinations)';
                    statusElement.style.color = '#28a745';
                } else if (totalCombinations <= 10000) {
                    statusElement.textContent = '‚ö° Trung b√¨nh (1K-10K combinations, ~1-3 ph√∫t)';
                    statusElement.style.color = '#ffc107';
                } else if (totalCombinations <= limit) {
                    statusElement.textContent = `üêå Ch·∫≠m (${(totalCombinations/1000).toFixed(0)}K combinations, ~${Math.ceil(totalCombinations/10000)} ph√∫t)`;
                    statusElement.style.color = '#fd7e14';
                } else {
                    statusElement.textContent = `‚ùå Qu√° nhi·ªÅu (>${(limit/1000).toFixed(0)}K limit) - S·∫Ω d√πng FALLBACK MODE`;
                    statusElement.style.color = '#dc3545';
                }
                
            } catch (error) {
                document.getElementById('totalCombinations').textContent = 'Error';
                document.getElementById('combinationsStatus').textContent = 'L·ªói t√≠nh to√°n';
            }
        }
        
        // Initialize combinations count
        updateCombinationsCount();
        
        function checkFiles() {
            const tradeFile = document.getElementById('tradeFile').files[0];
            const candleFile = document.getElementById('candleFile').files[0];
            const optimizeBtn = document.getElementById('optimizeBtn');
            const quickSummaryBtn = document.getElementById('quickSummaryBtn');
            
            if (tradeFile && candleFile) {
                optimizeBtn.disabled = false;
                quickSummaryBtn.disabled = false;
                updateStatus('ready', 'Files ƒë√£ s·∫µn s√†ng - C√≥ th·ªÉ b·∫Øt ƒë·∫ßu t·ªëi ∆∞u');
            } else {
                optimizeBtn.disabled = true;
                quickSummaryBtn.disabled = true;
            }
        }
        
        // Quick Summary
        async function getQuickSummary() {
            const tradeFile = document.getElementById('tradeFile').files[0];
            const candleFile = document.getElementById('candleFile').files[0];
            
            if (!tradeFile || !candleFile) {
                alert('Vui l√≤ng ch·ªçn c·∫£ 2 files!');
                return;
            }
            
            updateStatus('processing', 'ƒêang t·∫£i v√† ph√¢n t√≠ch d·ªØ li·ªáu...', true);
            showProgress('Quick Summary', 'ƒêang ƒë·ªçc files v√† t√≠nh to√°n...');
            
            try {
                currentController = new AbortController();
                const formData = new FormData();
                formData.append('trade_file', tradeFile);
                formData.append('candle_file', candleFile);
                
                setProgress(30, 'ƒêang upload files...');
                
                const response = await fetch('/quick_summary', {
                    method: 'POST',
                    body: formData,
                    signal: currentController.signal
                });
                
                setProgress(70, 'ƒêang x·ª≠ l√Ω d·ªØ li·ªáu...');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                setProgress(100, 'Ho√†n th√†nh!');
                
                if (data.success) {
                    displayQuickSummary(data.summary);
                    updateStatus('complete', 'Quick Summary ho√†n th√†nh!');
                } else {
                    throw new Error(data.error || 'Unknown error');
                }
                
            } catch (error) {
                if (error.name === 'AbortError') {
                    updateStatus('ready', 'ƒê√£ h·ªßy thao t√°c');
                } else {
                    console.error('Quick Summary Error:', error);
                    updateStatus('error', 'L·ªói: ' + error.message);
                }
            } finally {
                hideProgress();
                currentController = null;
            }
        }
        
        function displayQuickSummary(summary) {
            const summaryDiv = document.getElementById('quickSummary');
            const contentDiv = document.getElementById('summaryContent');
            
            contentDiv.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-top: 15px;">
                    <div style="text-align: center; padding: 15px; background: white; border-radius: 8px; border: 1px solid #ddd;">
                        <strong style="color: #007bff;">üìä T·ªïng s·ªë l·ªánh</strong><br>
                        <span style="font-size: 1.5em; color: #333;">${summary.total_trades}</span>
                    </div>
                    <div style="text-align: center; padding: 15px; background: white; border-radius: 8px; border: 1px solid #ddd;">
                        <strong style="color: #28a745;">‚úÖ L·ªánh h·ª£p l·ªá</strong><br>
                        <span style="font-size: 1.5em; color: #333;">${summary.valid_trades}</span>
                    </div>
                    <div style="text-align: center; padding: 15px; background: white; border-radius: 8px; border: 1px solid #ddd;">
                        <strong style="color: ${summary.total_pnl >= 0 ? '#28a745' : '#dc3545'};">üí∞ Total PnL</strong><br>
                        <span style="font-size: 1.5em; color: ${summary.total_pnl >= 0 ? '#28a745' : '#dc3545'};">${summary.total_pnl.toFixed(2)}%</span><br>
                        <small style="color: ${summary.total_pnl > 0 ? '#28a745' : '#dc3545'};">
                            ${summary.total_pnl > 0 ? '‚úÖ' : '‚ùå'} Khuy·∫øn c√°o: > 0%
                        </small>
                    </div>
                    <div style="text-align: center; padding: 15px; background: white; border-radius: 8px; border: 1px solid #ddd;">
                        <strong style="color: #17a2b8;">üéØ Win Rate</strong><br>
                        <span style="font-size: 1.5em; color: #333;">${summary.winrate.toFixed(1)}%</span><br>
                        <small style="color: ${summary.winrate > 50 ? '#28a745' : '#dc3545'};">
                            ${summary.winrate > 50 ? '‚úÖ' : '‚ùå'} Khuy·∫øn c√°o: > 50%
                        </small>
                    </div>
                    <div style="text-align: center; padding: 15px; background: white; border-radius: 8px; border: 1px solid #ddd;">
                        <strong style="color: #6f42c1;">üìà Profit Factor</strong><br>
                        <span style="font-size: 1.5em; color: #333;">${summary.profit_factor.toFixed(2)}</span><br>
                        <small style="color: ${summary.profit_factor > 1.5 ? '#28a745' : '#dc3545'};">
                            ${summary.profit_factor > 1.5 ? '‚úÖ' : '‚ùå'} Khuy·∫øn c√°o: > 1.5
                        </small>
                    </div>
                    <div style="text-align: center; padding: 15px; background: white; border-radius: 8px; border: 1px solid #ddd;">
                        <strong style="color: #dc3545;">üìâ Max Drawdown</strong><br>
                        <span style="font-size: 1.5em; color: #dc3545;">${summary.max_drawdown.toFixed(2)}%</span><br>
                        <small style="color: ${summary.max_drawdown < 20 ? '#28a745' : '#dc3545'};">
                            ${summary.max_drawdown < 20 ? '‚úÖ' : '‚ùå'} Khuy·∫øn c√°o: < 20%
                        </small>
                    </div>
                    <div style="text-align: center; padding: 15px; background: white; border-radius: 8px; border: 1px solid #ddd;">
                        <strong style="color: #20c997;">üìä Sharpe Ratio</strong><br>
                        <span style="font-size: 1.5em; color: #333;">${summary.sharpe_ratio.toFixed(3)}</span><br>
                        <small style="color: ${summary.sharpe_ratio > 1.0 ? '#28a745' : '#dc3545'};">
                            ${summary.sharpe_ratio > 1.0 ? '‚úÖ' : '‚ùå'} Khuy·∫øn c√°o: > 1.0
                        </small>
                    </div>
                    <div style="text-align: center; padding: 15px; background: white; border-radius: 8px; border: 1px solid #ddd;">
                        <strong style="color: #fd7e14;">üîÑ Recovery Factor</strong><br>
                        <span style="font-size: 1.5em; color: #333;">${summary.recovery_factor.toFixed(2)}</span><br>
                        <small style="color: ${summary.recovery_factor > 3.0 ? '#28a745' : '#dc3545'};">
                            ${summary.recovery_factor > 3.0 ? '‚úÖ' : '‚ùå'} Khuy·∫øn c√°o: > 3.0
                        </small>
                    </div>
                    <div style="text-align: center; padding: 15px; background: white; border-radius: 8px; border: 1px solid #ddd;">
                        <strong style="color: #fd7e14;">üìÖ Th·ªùi gian</strong><br>
                        <span style="font-size: 0.9em; color: #333;">${summary.date_range}</span>
                    </div>
                </div>
                <div style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <strong>üìà Chi ti·∫øt giao d·ªãch:</strong><br>
                            ‚Ä¢ Win: ${summary.win_trades} | Loss: ${summary.loss_trades}<br>
                            ‚Ä¢ Avg/Trade: ${summary.avg_trade.toFixed(2)}%<br>
                            ‚Ä¢ Avg Win: ${summary.avg_win.toFixed(2)}%<br>
                            ‚Ä¢ Avg Loss: ${summary.avg_loss.toFixed(2)}%
                        </div>
                        <div>
                            <strong>üìä Th·ªëng k√™ n√¢ng cao:</strong><br>
                            ‚Ä¢ Max Win Streak: ${summary.max_consecutive_wins}<br>
                            ‚Ä¢ Max Loss Streak: ${summary.max_consecutive_losses}<br>
                            ‚Ä¢ Candles: ${summary.candle_count.toLocaleString()}
                        </div>
                    </div>
                </div>
                
                <!-- ƒê√°nh gi√° t·ªïng th·ªÉ chi·∫øn l∆∞·ª£c -->
                <div style="margin-top: 15px; padding: 15px; border-radius: 8px; text-align: center;">
                    ${(() => {
                        const checks = [
                            summary.total_pnl > 0,
                            summary.winrate > 50,
                            summary.profit_factor > 1.5,
                            summary.max_drawdown < 20,
                            summary.sharpe_ratio > 1.0,
                            summary.recovery_factor > 3.0
                        ];
                        const passedChecks = checks.filter(check => check).length;
                        const totalChecks = checks.length;
                        const percentage = (passedChecks / totalChecks * 100);
                        
                        let color, evaluation, icon;
                        if (percentage >= 80) {
                            color = '#28a745';
                            evaluation = 'CHI·∫æN L∆Ø·ª¢C XU·∫§T S·∫ÆC';
                            icon = 'üèÜ';
                        } else if (percentage >= 60) {
                            color = '#ffc107';
                            evaluation = 'CHI·∫æN L∆Ø·ª¢C T·ªêT';
                            icon = 'üëç';
                        } else if (percentage >= 40) {
                            color = '#fd7e14';
                            evaluation = 'CHI·∫æN L∆Ø·ª¢C TRUNG B√åNH';
                            icon = '‚ö†Ô∏è';
                        } else {
                            color = '#dc3545';
                            evaluation = 'CHI·∫æN L∆Ø·ª¢C C·∫¶N C·∫¢I THI·ªÜN';
                            icon = '‚õî';
                        }
                        
                        return `
                            <div style="background: ${color}; color: white; padding: 20px; border-radius: 8px; font-weight: bold;">
                                <div style="font-size: 2em; margin-bottom: 10px;">${icon}</div>
                                <div style="font-size: 1.3em; margin-bottom: 10px;">${evaluation}</div>
                                <div style="font-size: 1em;">
                                    ƒê·∫°t ${passedChecks}/${totalChecks} ti√™u ch√≠ khuy·∫øn c√°o (${percentage.toFixed(0)}%)
                                </div>
                            </div>
                        `;
                    })()}
                </div>
            `;
            
            summaryDiv.style.display = 'block';
        }
        
        // Smart Parameter Suggestion
        async function suggestParameters() {
            const tradeFile = document.getElementById('tradeFile').files[0];
            
            if (!tradeFile) {
                alert('Vui l√≤ng ch·ªçn Trade CSV file ƒë·ªÉ ph√¢n t√≠ch!');
                return;
            }
            
            updateStatus('processing', 'ƒêang ph√¢n t√≠ch th√¥ng s·ªë th√¥ng minh...', true);
            showProgress('Smart Parameter Analysis', 'ƒêang ph√¢n t√≠ch tradelist data...');
            
            try {
                currentController = new AbortController();
                const formData = new FormData();
                formData.append('trade_file', tradeFile);
                
                setProgress(30, 'ƒêang upload v√† ph√¢n t√≠ch d·ªØ li·ªáu...');
                
                const response = await fetch('/suggest_parameters', {
                    method: 'POST',
                    body: formData,
                    signal: currentController.signal
                });
                
                setProgress(70, 'ƒêang t√≠nh to√°n d·∫£i th√¥ng s·ªë t·ªëi ∆∞u...');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                setProgress(100, 'Ho√†n th√†nh!');
                
                if (data.success) {
                    displayParameterSuggestion(data);
                    autoFillParameters(data.suggested_parameters);
                    updateStatus('complete', 'G·ª£i √Ω th√¥ng s·ªë ho√†n th√†nh!');
                } else {
                    throw new Error(data.error || 'Unknown error');
                }
                
            } catch (error) {
                if (error.name === 'AbortError') {
                    updateStatus('ready', 'ƒê√£ h·ªßy thao t√°c');
                } else {
                    console.error('Parameter Suggestion Error:', error);
                    updateStatus('error', 'L·ªói: ' + error.message);
                }
            } finally {
                hideProgress();
                currentController = null;
            }
        }
        
        function displayParameterSuggestion(data) {
            const suggestionDiv = document.getElementById('parameterSuggestion');
            const contentDiv = document.getElementById('suggestionContent');
            
            const params = data.suggested_parameters;
            const explanation = data.explanation;
            const efficiency = data.efficiency;

            // --- Warnings processing helpers ---
            function normalizeWarnings(warnings) {
                return (warnings || []).map(w => {
                    if (typeof w === 'string') return { code: 'UNKNOWN', message: w, value: null, human: w };
                    try {
                        return {
                            code: w.code || 'UNKNOWN',
                            message: w.message || (typeof w === 'object' && w.message) || '',
                            value: (w && (w.value !== undefined)) ? w.value : null,
                            human: w.human || w.message || JSON.stringify(w)
                        };
                    } catch (e) {
                        return { code: 'UNKNOWN', message: String(w), value: null, human: String(w) };
                    }
                });
            }

            function dedupeWarnings(warnings) {
                const seen = new Set();
                const out = [];
                warnings.forEach(w => {
                    const key = `${w.code}::${w.human}`;
                    if (!seen.has(key)) {
                        seen.add(key);
                        out.push(w);
                    }
                });
                return out;
            }

            function groupWarnings(warnings) {
                const groups = {};
                warnings.forEach(w => {
                    const key = w.code || 'UNKNOWN';
                    if (!groups[key]) groups[key] = [];
                    groups[key].push(w);
                });
                return groups;
            }

            function buildWarningsHtml(groups) {
                let html = '';
                Object.keys(groups).forEach(code => {
                    const items = groups[code];
                    html += `<div style="margin-top:8px; padding-top:6px; border-top:1px dashed rgba(0,0,0,0.05);">
                                <div style="font-weight:700; margin-bottom:6px;">${code} <small style=\"color:#666; font-weight:400;\">(${items.length})</small></div>
                                <ul style="margin:0 0 0 18px; color:#856404;">`;
                    html += items.map(w => `<li>${w.human}${(w.value !== null && w.value !== undefined) ? ` ‚Äî <span style=\"color:#333; font-weight:600;\">${w.value}</span>` : ''}</li>`).join('');
                    html += `</ul></div>`;
                });
                return html;
            }

            // Copy deduped warnings JSON to clipboard
            window.copyWarningsAsJSON = function(warnings) {
                try {
                    const txt = JSON.stringify(warnings, null, 2);
                    if (navigator && navigator.clipboard && navigator.clipboard.writeText) {
                        navigator.clipboard.writeText(txt).then(() => {
                            alert('Warnings copied to clipboard.');
                        }).catch(() => {
                            // fallback
                            prompt('Copy the warnings JSON below (Ctrl+C):', txt);
                        });
                    } else {
                        prompt('Copy the warnings JSON below (Ctrl+C):', txt);
                    }
                } catch (e) {
                    alert('Unable to copy warnings JSON.');
                }
            };

            // Prepare deduped & grouped warnings HTML
            const rawWarnings = data.warnings || [];
            const normalizedWarnings = normalizeWarnings(rawWarnings);
            const dedupedWarnings = dedupeWarnings(normalizedWarnings);
            const groupedWarnings = groupWarnings(dedupedWarnings);
            // expose for copy button
            window._lastWarningsForCopy = dedupedWarnings;
            const warningsHtml = (dedupedWarnings.length > 0) ? `
                <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
                    <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
                        <h5 style="color: #856404; margin:0;">‚ö†Ô∏è C·∫£nh b√°o t·ª± ƒë·ªông</h5>
                        <div>
                            <button class="btn" onclick="copyWarningsAsJSON(window._lastWarningsForCopy)" style="font-size:0.9em; padding:6px 8px;">üìã Copy warnings as JSON</button>
                        </div>
                    </div>
                    ${buildWarningsHtml(groupedWarnings)}
                    ${ (dedupedWarnings.some(w => (String(w.code).toLowerCase().includes('ts') && String(w.code).toLowerCase().includes('trig')) || (w.human && (w.human.toLowerCase().includes('ts_trig') || w.human.toLowerCase().includes('ts trig'))))) ? `
                        <div style="margin-top:10px; padding:10px; background:#f8d7da; border-radius:6px; color:#721c24;">
                            <strong>Th√¥ng tin TS:</strong> H·ªá th·ªëng ƒë√£ √°p d·ª•ng gi·ªõi h·∫°n t·ªëi thi·ªÉu cho TS Trigger. Gi√° tr·ªã hi·ªÉn th·ªã ·ªü tr√™n (TS Trigger min) l√† gi√° tr·ªã ƒë√£ ƒë∆∞·ª£c √°p d·ª•ng.
                        </div>
                    ` : '' }
                </div>
            ` : `
                <div style="margin-top: 20px; padding: 15px; background: #d1ecf1; border-radius: 8px; border-left: 4px solid #17a2b8;">
                    <h5 style="color: #0c5460;">‚úÖ C√°c th√¥ng s·ªë ƒë√£ ƒë∆∞·ª£c t·ª± ƒë·ªông ƒëi·ªÅn v√†o form!</h5>
                    <p style="margin: 5px 0; color: #0c5460;">B·∫°n c√≥ th·ªÉ ƒëi·ªÅu ch·ªânh c√°c gi√° tr·ªã n√†y n·∫øu c·∫ßn tr∆∞·ªõc khi ch·∫°y Grid Search.</p>
                </div>
            `;
            
            contentDiv.innerHTML = `
                <div class="suggestion-grid">
                    <div class="suggestion-explanation">
                        <h4>üìä C∆° s·ªü Ph√¢n t√≠ch</h4>
                        <p><strong>D·ªØ li·ªáu:</strong> ${explanation.data_analysis}</p>
                        <p><strong>Chi·∫øn l∆∞·ª£c:</strong> ${explanation.strategy_selected}</p>
                        
                        <h5 style="margin-top: 15px; color: #007bff;">üî¨ N·ªÅn t·∫£ng Th·ªëng k√™:</h5>
                        <ul style="margin: 10px 0; padding-left: 20px;">
                            ${explanation.statistical_foundation.map(item => `<li>${item}</li>`).join('')}
                        </ul>
                        
                        <h5 style="margin-top: 15px; color: #28a745;">üìè Logic Step:</h5>
                        <ul style="margin: 10px 0; padding-left: 20px; font-size: 0.9em;">
                            ${explanation.step_logic.map(item => `<li>${item}</li>`).join('')}
                        </ul>
                    </div>
                    
                    <div class="efficiency-metrics">
                        <h4>‚ö° Hi·ªáu qu·∫£ T·ªëi ∆∞u</h4>
                        <div style="text-align: center; margin: 15px 0;">
                            <div style="font-size: 2em; color: #28a745; font-weight: bold;">
                                ${efficiency.efficiency}
                            </div>
                            <div style="color: #666;">times faster</div>
                        </div>
                        
                        <p><strong>Smart Combinations:</strong> ${efficiency.smart_combinations.toLocaleString()}</p>
                        <p><strong>Th·ªùi gian ti·∫øt ki·ªám:</strong> ${efficiency.estimated_time_savings}</p>
                        
                        <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                            <h5 style="color: #007bff;">üéØ Th√¥ng s·ªë ƒë∆∞·ª£c g·ª£i √Ω:</h5>
                                <div style="font-size: 0.9em; margin-top: 8px;">
                                <strong>SL:</strong> ${params.sl_min}%-${params.sl_max}% (step: ${params.sl_step})<br>
                                <strong>BE:</strong> ${params.be_min}%-${params.be_max}% (step: ${params.be_step})<br>
                                <strong>TS Trigger:</strong> ${params.ts_trig_min}%-${params.ts_trig_max}% (step: ${params.ts_trig_step})<br>
                                <strong>TS Step:</strong> ${params.ts_step_min}%-${params.ts_step_max}% (step: ${params.ts_step_step})<br>
                                <strong>TP Levels:</strong> ${data.tp_levels ? `TP1=${data.tp_levels.TP1 || 'N/A'}%  TP2=${data.tp_levels.TP2 || 'N/A'}%  TP3=${data.tp_levels.TP3 || 'N/A'}%` : 'N/A'}
                            </div>
                        </div>
                    </div>
                </div>
                
                        <!-- Warnings block: show any warnings returned by the analysis (e.g., TS clamp) -->
                        ${ (data.warnings && data.warnings.length>0) ? `
                            <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
                                <h5 style="color: #856404;">‚ö†Ô∏è C·∫£nh b√°o t·ª± ƒë·ªông</h5>
                                <ul style="margin: 5px 0 0 18px; color: #856404;">
                                    ${data.warnings.map(w => `<li>${(w && w.human) ? w.human : (typeof w === 'string' ? w : JSON.stringify(w))}</li>`).join('')}
                                </ul>
                                ${ (data.warnings.some(w => (
                                    (w && w.code && String(w.code).toLowerCase().includes('ts') && String(w.code).toLowerCase().includes('trig')) ||
                                    (typeof w === 'string' && (w.toLowerCase().includes('ts_trig') || w.toLowerCase().includes('ts trig'))) ||
                                    (w && w.human && (w.human.toLowerCase().includes('ts_trig') || w.human.toLowerCase().includes('ts trig')))
                                ))) ? `
                                    <div style="margin-top:10px; padding:10px; background:#f8d7da; border-radius:6px; color:#721c24;">
                                        <strong>Th√¥ng tin TS:</strong> H·ªá th·ªëng ƒë√£ √°p d·ª•ng gi·ªõi h·∫°n t·ªëi thi·ªÉu cho TS Trigger. Gi√° tr·ªã hi·ªÉn th·ªã ·ªü tr√™n (TS Trigger min) l√† gi√° tr·ªã ƒë√£ ƒë∆∞·ª£c √°p d·ª•ng.
                                    </div>
                                ` : '' }
                            </div>
                        ` : `
                            <div style="margin-top: 20px; padding: 15px; background: #d1ecf1; border-radius: 8px; border-left: 4px solid #17a2b8;">
                                <h5 style="color: #0c5460;">‚úÖ C√°c th√¥ng s·ªë ƒë√£ ƒë∆∞·ª£c t·ª± ƒë·ªông ƒëi·ªÅn v√†o form!</h5>
                                <p style="margin: 5px 0; color: #0c5460;">B·∫°n c√≥ th·ªÉ ƒëi·ªÅu ch·ªânh c√°c gi√° tr·ªã n√†y n·∫øu c·∫ßn tr∆∞·ªõc khi ch·∫°y Grid Search.</p>
                            </div>
                        ` }
            `;
            
            suggestionDiv.style.display = 'block';
        }
        
        function autoFillParameters(params) {
            // Auto-fill all parameter inputs
            document.getElementById('slMin').value = params.sl_min.toFixed(1);
            document.getElementById('slMax').value = params.sl_max.toFixed(1);
            document.getElementById('slStep').value = params.sl_step;
            
            document.getElementById('beMin').value = params.be_min.toFixed(2);
            document.getElementById('beMax').value = params.be_max.toFixed(2);
            document.getElementById('beStep').value = params.be_step;
            
            document.getElementById('tsTrigMin').value = params.ts_trig_min.toFixed(2);
            document.getElementById('tsTrigMax').value = params.ts_trig_max.toFixed(2);
            document.getElementById('tsTrigStep').value = params.ts_trig_step;
            
            document.getElementById('tsStepMin').value = params.ts_step_min.toFixed(2);
            document.getElementById('tsStepMax').value = params.ts_step_max.toFixed(2);
            document.getElementById('tsStepStep').value = params.ts_step_step;
            
            // Visual feedback - highlight filled fields briefly
            const inputIds = ['slMin', 'slMax', 'slStep', 'beMin', 'beMax', 'beStep', 
                             'tsTrigMin', 'tsTrigMax', 'tsTrigStep', 'tsStepMin', 'tsStepMax', 'tsStepStep'];
            
            inputIds.forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    input.style.backgroundColor = '#d4edda';
                    input.style.borderColor = '#28a745';
                    setTimeout(() => {
                        input.style.backgroundColor = '';
                        input.style.borderColor = '';
                    }, 2000);
                }
            });
        }
        
        // Optimization
        async function startOptimization() {
            const tradeFile = document.getElementById('tradeFile').files[0];
            const candleFile = document.getElementById('candleFile').files[0];
            
            if (!tradeFile || !candleFile) {
                alert('Vui l√≤ng ch·ªçn c·∫£ 2 files!');
                return;
            }
            
            updateStatus('processing', 'ƒêang ch·∫°y t·ªëi ∆∞u h√≥a...', true);
            showProgress('Grid Search Optimization', 'ƒêang kh·ªüi t·∫°o...');
            
            // Show cancel button
            document.getElementById('optimizeBtn').style.display = 'none';
            document.getElementById('cancelBtn').style.display = 'inline-block';
            
            try {
                currentController = new AbortController();
                const formData = new FormData();
                // Add files
                formData.append('trade_file', tradeFile);
                formData.append('candle_file', candleFile);
                // Add parameters
                formData.append('max_trades', document.getElementById('maxTrades').value);
                formData.append('start_trade', document.getElementById('startTrade').value);
                formData.append('trade_selection_mode', document.getElementById('tradeSelectionMode').value);
                // Only send SL values if SL optimization is enabled; otherwise send 0 to indicate disabled
                if (document.getElementById('optimizeSL').checked) {
                    formData.append('sl_min', document.getElementById('slMin').value);
                    formData.append('sl_max', document.getElementById('slMax').value);
                    formData.append('sl_step', document.getElementById('slStep').value);
                } else {
                    formData.append('sl_min', '0');
                    formData.append('sl_max', '0');
                    formData.append('sl_step', '0');
                }
                formData.append('be_min', document.getElementById('beMin').value);
                formData.append('be_max', document.getElementById('beMax').value);
                formData.append('be_step', document.getElementById('beStep').value);
                formData.append('ts_trig_min', document.getElementById('tsTrigMin').value);
                formData.append('ts_trig_max', document.getElementById('tsTrigMax').value);
                formData.append('ts_trig_step', document.getElementById('tsTrigStep').value);
                formData.append('ts_step_min', document.getElementById('tsStepMin').value);
                formData.append('ts_step_max', document.getElementById('tsStepMax').value);
                formData.append('ts_step_step', document.getElementById('tsStepStep').value);
                formData.append('opt_type', document.getElementById('optType').value);
                formData.append('force_advanced_mode', document.getElementById('forceAdvanced').checked);
                formData.append('method_type', document.getElementById('method_type').value);

                // L·∫•y danh s√°ch c√°c th√¥ng s·ªë c·∫ßn t·ªëi ∆∞u
                let optimizeParams = [];
                if (document.getElementById('optimizeSL').checked) optimizeParams.push('sl');
                if (document.getElementById('optimizeBE').checked) optimizeParams.push('be');
                if (document.getElementById('optimizeTS').checked) optimizeParams.push('ts');
                formData.append('optimize_params', JSON.stringify(optimizeParams));

                // Calculate expected combinations for progress (gi·ªØ nguy√™n logic c≈©)
                const slMin = parseFloat(document.getElementById('slMin').value);
                const slMax = parseFloat(document.getElementById('slMax').value);
                const slStep = parseFloat(document.getElementById('slStep').value);
                const beMin = parseFloat(document.getElementById('beMin').value);
                const beMax = parseFloat(document.getElementById('beMax').value);
                const beStep = parseFloat(document.getElementById('beStep').value);
                const tsTrigMin = parseFloat(document.getElementById('tsTrigMin').value);
                const tsTrigMax = parseFloat(document.getElementById('tsTrigMax').value);
                const tsTrigStep = parseFloat(document.getElementById('tsTrigStep').value);
                const tsStepMin = parseFloat(document.getElementById('tsStepMin').value);
                const tsStepMax = parseFloat(document.getElementById('tsStepMax').value);
                const tsStepStep = parseFloat(document.getElementById('tsStepStep').value);

                const slCount = Math.floor((slMax - slMin) / slStep) + 1;
                const beCount = beMax > beMin ? Math.floor((beMax - beMin) / beStep) + 1 : 1;
                const tsTrigCount = tsTrigMax > tsTrigMin ? Math.floor((tsTrigMax - tsTrigMin) / tsTrigStep) + 1 : 1;
                const tsStepCount = tsStepMax > tsStepMin ? Math.floor((tsStepMax - tsStepMin) / tsStepStep) + 1 : 1;
                const totalCombinations = slCount * beCount * tsTrigCount * tsStepCount;

                const forceAdvanced = document.getElementById('forceAdvanced').checked;
                const warningMsg = totalCombinations > 1000 && !forceAdvanced 
                    ? ` (‚ö†Ô∏è FALLBACK MODE: Ch·ªâ test ${slCount} SL values!)` 
                    : totalCombinations > 1000 
                    ? ` (üö® ADVANCED MODE: C√≥ th·ªÉ m·∫•t nhi·ªÅu ph√∫t!)` 
                    : '';

                setProgress(10, `S·∫Ω test ${totalCombinations.toLocaleString()} t·ªï h·ª£p (SL:${slCount} √ó BE:${beCount} √ó TS:${tsTrigCount}√ó${tsStepCount})${warningMsg}...`);

                const response = await fetch('/optimize', {
                    method: 'POST',
                    body: formData,
                    signal: currentController.signal
                });

                setProgress(50, 'ƒêang nh·∫≠n k·∫øt qu·∫£...');

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                setProgress(100, 'Ho√†n th√†nh!');

                if (data.error) {
                    throw new Error(data.error);
                }

                displayResults(data);
                updateStatus('complete', 'T·ªëi ∆∞u ho√†n th√†nh th√†nh c√¥ng!');

            } catch (error) {
                if (error.name === 'AbortError') {
                    updateStatus('ready', 'ƒê√£ h·ªßy t·ªëi ∆∞u h√≥a');
                } else {
                    console.error('Optimization Error:', error);
                    updateStatus('error', 'L·ªói t·ªëi ∆∞u: ' + error.message);
                }
            } finally {
                hideProgress();
                currentController = null;
                // Show optimize button, hide cancel button
                document.getElementById('optimizeBtn').style.display = 'inline-block';
                document.getElementById('cancelBtn').style.display = 'none';
            }
        }
        
        function cancelOperation() {
            if (currentController) {
                currentController.abort();
                updateStatus('ready', 'ƒêang h·ªßy thao t√°c...');
            }
        }
        
        function displayResults(data) {
            const resultsDiv = document.getElementById('results');
            
            let html = '<div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-top: 20px;">';
            html += '<h2>üéâ K·∫øt qu·∫£ t·ªëi ∆∞u v·ªõi Advanced Metrics</h2>';
            
            // Mode indicator with detailed info
            const modeColor = data.mode === 'ADVANCED' ? '#28a745' : '#ffc107';
            const modeIcon = data.mode === 'ADVANCED' ? 'üöÄ' : '‚ö°';
            html += `<div style="display: inline-block; padding: 8px 15px; background: ${modeColor}; color: white; border-radius: 20px; margin-bottom: 15px; font-weight: bold;">`;
            html += `${modeIcon} ${data.mode} MODE`;
            if (data.mode === 'ADVANCED') {
                html += ' - Full SL+BE+TS Optimization';
            } else {
                html += ' - SL Only (BE/TS Fixed)';
            }
            html += '</div>';
            
            // Show mode details if available
            if (data.mode_details) {
                const details = data.mode_details;
                if (details.warning) {
                    html += `<div style="background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; padding: 10px; border-radius: 5px; margin-bottom: 15px;">`;
                    html += `<strong>‚ö†Ô∏è ${details.warning}</strong><br>`;
                    html += `Tested ${details.actual_tests_run?.toLocaleString() || 'N/A'} combinations instead of ${details.total_combinations?.toLocaleString() || 'N/A'}<br>`;
                    html += `Scope: ${details.optimization_scope || 'Unknown'}`;
                    if (details.fallback_reason) {
                        html += `<br>Reason: ${details.fallback_reason}`;
                    }
                    html += '</div>';
                }
            }
            
            if (data.filter_info) {
                html += `<div class="alert alert-info">${data.filter_info}</div>`;
            }
            
            if (data.best_result) {
                const best = data.best_result;
                const baseline = data.baseline;
                
                html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">';
                
                // Baseline
                html += '<div style="background: white; padding: 20px; border-radius: 10px; border: 2px solid #6c757d;">';
                html += '<h4 style="color: #6c757d;">üìä K·∫øt qu·∫£ g·ªëc (No SL)</h4>';
                html += `<div style="font-size: 1.5em; color: ${baseline.pnl_total >= 0 ? '#28a745' : '#dc3545'}; margin: 10px 0;">`;
                html += `${baseline.pnl_total.toFixed(2)}%</div>`;
                html += `<div style="color: #666;">Win Rate: ${baseline.winrate.toFixed(1)}%</div>`;
                html += `<div style="color: #666;">Trades: ${baseline.trade_count}</div>`;
                html += '</div>';
                
                // Best result
                html += '<div style="background: white; padding: 20px; border-radius: 10px; border: 2px solid #28a745;">';
                html += '<h4 style="color: #28a745;">üèÜ K·∫øt qu·∫£ t·ªëi ∆∞u</h4>';
                html += `<div style="font-size: 1.5em; color: ${best.pnl_total >= 0 ? '#28a745' : '#dc3545'}; margin: 10px 0;">`;
                html += `${best.pnl_total.toFixed(2)}%</div>`;
                html += `<div style="color: #666;">SL: ${best.sl}% | BE: ${best.be}% | TS: ${best.ts_trig}%/${best.ts_step}%</div>`;
                html += `<div style="color: #666;">Win Rate: ${best.winrate.toFixed(1)}% | PF: ${best.pf.toFixed(2)}</div>`;
                html += `<div style="color: #666;">Max DD: ${best.max_drawdown ? best.max_drawdown.toFixed(2) : '0.00'}% | Sharpe: ${best.sharpe_ratio ? best.sharpe_ratio.toFixed(3) : '0.000'}</div>`;
                html += `<div style="color: #666;">Recovery: ${best.recovery_factor ? best.recovery_factor.toFixed(2) : '0.00'} | Win/Loss: ${best.trade_win}/${best.trade_loss}</div>`;
                html += `<div style="color: #666;">Avg Win: ${best.avg_win ? best.avg_win.toFixed(2) : '0.00'}% | Avg Loss: ${best.avg_loss ? best.avg_loss.toFixed(2) : '0.00'}%</div>`;
                html += `<div style="color: #666;">Max Streaks: +${best.max_consecutive_wins || 0} / -${best.max_consecutive_losses || 0}</div>`;
                
                const improvement = best.pnl_total - baseline.pnl_total;
                html += `<div style="margin-top: 10px; padding: 10px; background: ${improvement >= 0 ? '#d4edda' : '#f8d7da'}; border-radius: 5px;">`;
                html += `<strong>C·∫£i thi·ªán: ${improvement >= 0 ? '+' : ''}${improvement.toFixed(2)}%</strong>`;
                html += '</div>';
                html += '</div>';
                
                html += '</div>';
                
                // Show top results table
                if (data.all_results && data.all_results.length > 0) {
                    html += '<div style="margin-top: 20px;">';
                    html += '<h4>üìã Top 10 k·∫øt qu·∫£</h4>';
                    html += '<div style="overflow-x: auto;">';
                    html += '<table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden;">';
                    html += '<thead style="background: #007bff; color: white;"><tr>';
                    html += '<th style="padding: 8px; text-align: center; font-size: 0.9em;">Rank</th>';
                    html += '<th style="padding: 8px; text-align: center; font-size: 0.9em;">SL (%)</th>';
                    html += '<th style="padding: 8px; text-align: center; font-size: 0.9em;">BE (%)</th>';
                    html += '<th style="padding: 8px; text-align: center; font-size: 0.9em;">TS Trig (%)</th>';
                    html += '<th style="padding: 8px; text-align: center; font-size: 0.9em;">TS Step (%)</th>';
                    html += '<th style="padding: 8px; text-align: center; font-size: 0.9em;">PnL (%)</th>';
                    html += '<th style="padding: 8px; text-align: center; font-size: 0.9em;">Win Rate (%)</th>';
                    html += '<th style="padding: 8px; text-align: center; font-size: 0.9em;">Profit Factor</th>';
                    html += '<th style="padding: 8px; text-align: center; font-size: 0.9em;">Max DD (%)</th>';
                    html += '<th style="padding: 8px; text-align: center; font-size: 0.9em;">Sharpe</th>';
                    html += '<th style="padding: 8px; text-align: center; font-size: 0.9em;">Recovery</th>';
                    html += '</tr></thead><tbody>';
                    
                    data.all_results.slice(0, 10).forEach((result, index) => {
                        const rowColor = index % 2 === 0 ? '#f8f9fa' : 'white';
                        const pnlColor = result.pnl_total >= 0 ? '#28a745' : '#dc3545';
                        const ddColor = result.max_drawdown > 20 ? '#dc3545' : result.max_drawdown > 10 ? '#ffc107' : '#28a745';
                        html += `<tr style="background: ${rowColor};">`;
                        html += `<td style="padding: 8px; text-align: center; font-weight: bold; font-size: 0.9em;">${index + 1}</td>`;
                        html += `<td style="padding: 8px; text-align: center; font-size: 0.9em;">${result.sl.toFixed(1)}</td>`;
                        html += `<td style="padding: 8px; text-align: center; font-size: 0.9em;">${result.be.toFixed(1)}</td>`;
                        html += `<td style="padding: 8px; text-align: center; font-size: 0.9em;">${result.ts_trig.toFixed(1)}</td>`;
                        html += `<td style="padding: 8px; text-align: center; font-size: 0.9em;">${result.ts_step.toFixed(1)}</td>`;
                        html += `<td style="padding: 8px; text-align: center; color: ${pnlColor}; font-weight: bold; font-size: 0.9em;">${result.pnl_total.toFixed(2)}</td>`;
                        html += `<td style="padding: 8px; text-align: center; font-size: 0.9em;">${result.winrate.toFixed(1)}</td>`;
                        html += `<td style="padding: 8px; text-align: center; font-size: 0.9em;">${result.pf.toFixed(2)}</td>`;
                        html += `<td style="padding: 8px; text-align: center; color: ${ddColor}; font-size: 0.9em;">${result.max_drawdown ? result.max_drawdown.toFixed(2) : '0.00'}</td>`;
                        html += `<td style="padding: 8px; text-align: center; font-size: 0.9em;">${result.sharpe_ratio ? result.sharpe_ratio.toFixed(3) : '0.000'}</td>`;
                        html += `<td style="padding: 8px; text-align: center; font-size: 0.9em;">${result.recovery_factor ? result.recovery_factor.toFixed(2) : '0.00'}</td>`;
                        html += '</tr>';
                    });
                    
                    html += '</tbody></table></div></div>';
                }
            }
            
            // Th√™m b·∫£ng log chi ti·∫øt c√°c l·ªánh
            if (data.trade_comparison && data.trade_comparison.length > 0) {
                html += `
                    <div style="margin-top: 30px; padding: 20px; background: white; border-radius: 8px; border: 1px solid #ddd;">
                        <h3 style="color: #333; margin-bottom: 15px;">üìä Chi Ti·∫øt So S√°nh C√°c L·ªánh (Top ${data.trade_comparison.length})</h3>
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse; font-size: 0.85em;">
                                <thead>
                                    <tr style="background: #f8f9fa;">
                                        <th style="border: 1px solid #dee2e6; padding: 8px; text-align: center;">#</th>
                                        <th style="border: 1px solid #dee2e6; padding: 8px; text-align: center;">Th·ªùi Gian</th>
                                        <th style="border: 1px solid #dee2e6; padding: 8px; text-align: center;">Side</th>
                                        <th style="border: 1px solid #dee2e6; padding: 8px; text-align: center;">Entry Price</th>
                                        <th style="border: 1px solid #dee2e6; padding: 8px; text-align: center;">Exit G·ªëc</th>
                                        <th style="border: 1px solid #dee2e6; padding: 8px; text-align: center;">Exit Type G·ªëc</th>
                                        <th style="border: 1px solid #dee2e6; padding: 8px; text-align: center;">PnL G·ªëc (%)</th>
                                        <th style="border: 1px solid #dee2e6; padding: 8px; text-align: center;">Exit T·ªëi ∆Øu</th>
                                        <th style="border: 1px solid #dee2e6; padding: 8px; text-align: center;">Exit Type T·ªëi ∆Øu</th>
                                        <th style="border: 1px solid #dee2e6; padding: 8px; text-align: center;">PnL T·ªëi ∆Øu (%)</th>
                                        <th style="border: 1px solid #dee2e6; padding: 8px; text-align: center;">C·∫£i Thi·ªán (%)</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                data.trade_comparison.forEach((trade, index) => {
                    const rowColor = index % 2 === 0 ? '#f9f9f9' : 'white';
                    const baselinePnlColor = trade.baseline_pnl >= 0 ? '#28a745' : '#dc3545';
                    const optimizedPnlColor = trade.optimized_pnl >= 0 ? '#28a745' : '#dc3545';
                    const improvementColor = trade.improvement > 0 ? '#28a745' : (trade.improvement < 0 ? '#dc3545' : '#6c757d');
                    
                    // Highlight exit type v·ªõi m√†u
                    const getExitTypeColor = (exitType) => {
                        if (exitType.includes('SL')) return '#dc3545';
                        if (exitType.includes('BE')) return '#ffc107';
                        if (exitType.includes('TS')) return '#17a2b8';
                        return '#6c757d';
                    };
                    
                    // Dynamic price formatting function
                    const formatPrice = (price) => {
                        if (price < 0.01) {
                            // For very small prices like BOME (0.009xxx), use 6 decimal places
                            return price.toFixed(6);
                        } else if (price < 1) {
                            // For prices between 0.01-1, use 4 decimal places
                            return price.toFixed(4);
                        } else if (price < 100) {
                            // For prices between 1-100, use 2 decimal places
                            return price.toFixed(2);
                        } else {
                            // For large prices, use 0 decimal places
                            return price.toFixed(0);
                        }
                    };
                    
                    html += `
                        <tr style="background: ${rowColor};">
                            <td style="border: 1px solid #dee2e6; padding: 6px; text-align: center; font-weight: bold;">${trade.trade_num}</td>
                            <td style="border: 1px solid #dee2e6; padding: 6px; text-align: center;">${trade.entry_time}</td>
                            <td style="border: 1px solid #dee2e6; padding: 6px; text-align: center; font-weight: bold; color: ${trade.side === 'LONG' ? '#28a745' : '#dc3545'};">${trade.side}</td>
                            <td style="border: 1px solid #dee2e6; padding: 6px; text-align: center;">${formatPrice(trade.entry_price)}</td>
                            <td style="border: 1px solid #dee2e6; padding: 6px; text-align: center;">${formatPrice(trade.baseline_exit_price)}</td>
                            <td style="border: 1px solid #dee2e6; padding: 6px; text-align: center; color: ${getExitTypeColor(trade.baseline_exit_type)}; font-weight: bold;">${trade.baseline_exit_type}</td>
                            <td style="border: 1px solid #dee2e6; padding: 6px; text-align: center; color: ${baselinePnlColor}; font-weight: bold;">${trade.baseline_pnl.toFixed(2)}</td>
                            <td style="border: 1px solid #dee2e6; padding: 6px; text-align: center;">${formatPrice(trade.optimized_exit_price)}</td>
                            <td style="border: 1px solid #dee2e6; padding: 6px; text-align: center; color: ${getExitTypeColor(trade.optimized_exit_type)}; font-weight: bold;">${trade.optimized_exit_type}</td>
                            <td style="border: 1px solid #dee2e6; padding: 6px; text-align: center; color: ${optimizedPnlColor}; font-weight: bold;">${trade.optimized_pnl.toFixed(2)}</td>
                            <td style="border: 1px solid #dee2e6; padding: 6px; text-align: center; color: ${improvementColor}; font-weight: bold;">${trade.improvement > 0 ? '+' : ''}${trade.improvement.toFixed(2)}</td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table></div>';
                
                // Th√™m th·ªëng k√™ t√≥m t·∫Øt
                const improvedTrades = data.trade_comparison.filter(t => t.improvement > 0).length;
                const worsenedTrades = data.trade_comparison.filter(t => t.improvement < 0).length;
                const unchangedTrades = data.trade_comparison.filter(t => t.improvement === 0).length;
                const avgImprovement = data.trade_comparison.reduce((sum, t) => sum + t.improvement, 0) / data.trade_comparison.length;
                
                html += `
                    <div style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <strong>üìà Th·ªëng K√™ C·∫£i Thi·ªán:</strong><br>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-top: 10px;">
                            <div>‚úÖ C·∫£i thi·ªán: <span style="color: #28a745; font-weight: bold;">${improvedTrades} l·ªánh</span></div>
                            <div>‚ùå X·∫•u ƒëi: <span style="color: #dc3545; font-weight: bold;">${worsenedTrades} l·ªánh</span></div>
                            <div>‚ûñ Kh√¥ng ƒë·ªïi: <span style="color: #6c757d; font-weight: bold;">${unchangedTrades} l·ªánh</span></div>
                            <div>üìä Trung b√¨nh: <span style="color: ${avgImprovement >= 0 ? '#28a745' : '#dc3545'}; font-weight: bold;">${avgImprovement > 0 ? '+' : ''}${avgImprovement.toFixed(2)}%</span></div>
                        </div>
                    </div>
                `;
                
                html += '</div>';
            }
            
            // Th√™m bi·ªÉu ƒë·ªì so s√°nh PnL t√≠ch l≈©y
            if (data.cumulative_comparison && data.cumulative_comparison.labels && data.cumulative_comparison.labels.length > 0) {
                html += `
                    <div style="margin-top: 30px; padding: 20px; background: white; border-radius: 8px; border: 1px solid #ddd;">
                        <h3 style="color: #333; margin-bottom: 15px;">üìà Bi·ªÉu ƒê·ªì So S√°nh PnL T√≠ch L≈©y</h3>
                        <canvas id="cumulativePnlChart" width="800" height="400" style="max-width: 100%; height: 400px;"></canvas>
                        <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 6px; font-size: 0.9em;">
                            <strong>üìä Ch√∫ Th√≠ch:</strong><br>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 10px; margin-top: 8px;">
                                <div><span style="color: #dc3545; font-weight: bold;">‚óè</span> ${data.cumulative_comparison.baseline_label || 'K·∫øt qu·∫£ g·ªëc'}</div>
                                <div><span style="color: #28a745; font-weight: bold;">‚óè</span> ${data.cumulative_comparison.optimized_label || 'K·∫øt qu·∫£ t·ªëi ∆∞u'}</div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            resultsDiv.innerHTML = html;
            
            // V·∫Ω bi·ªÉu ƒë·ªì sau khi DOM ƒë∆∞·ª£c c·∫≠p nh·∫≠t
            if (data.cumulative_comparison && data.cumulative_comparison.labels && data.cumulative_comparison.labels.length > 0) {
                drawCumulativePnlChart(data.cumulative_comparison);
            }
        }
        
        function drawCumulativePnlChart(cumulativeData) {
            const canvas = document.getElementById('cumulativePnlChart');
            if (!canvas) {
                console.error('Canvas element not found');
                return;
            }
            
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            
            // Clear canvas
            ctx.clearRect(0, 0, width, height);
            
            const { labels, baseline_cumulative, optimized_cumulative } = cumulativeData;
            
            if (!labels || labels.length === 0) return;
            
            // T√≠nh min/max values cho scaling
            const allValues = [...(baseline_cumulative || []), ...(optimized_cumulative || [])];
            const minValue = Math.min(...allValues, 0);
            const maxValue = Math.max(...allValues, 0);
            const valueRange = maxValue - minValue;
            
            // Margins
            const margin = { top: 20, right: 80, bottom: 60, left: 80 };
            const chartWidth = width - margin.left - margin.right;
            const chartHeight = height - margin.top - margin.bottom;
            
            // Helper functions
            const xScale = (index) => margin.left + (index / (labels.length - 1)) * chartWidth;
            const yScale = (value) => margin.top + ((maxValue - value) / valueRange) * chartHeight;
            
            // Draw grid
            ctx.strokeStyle = '#e0e0e0';
            ctx.lineWidth = 1;
            
            // Horizontal grid lines
            for (let i = 0; i <= 5; i++) {
                const value = minValue + (valueRange * i / 5);
                const y = yScale(value);
                ctx.beginPath();
                ctx.moveTo(margin.left, y);
                ctx.lineTo(margin.left + chartWidth, y);
                ctx.stroke();
                
                // Y-axis labels
                ctx.fillStyle = '#666';
                ctx.font = '12px Arial';
                ctx.textAlign = 'right';
                ctx.fillText(value.toFixed(1) + '%', margin.left - 10, y + 4);
            }
            
            // Vertical grid lines (every 10th point or max 10 lines)
            const gridStep = Math.max(1, Math.floor(labels.length / 10));
            for (let i = 0; i < labels.length; i += gridStep) {
                const x = xScale(i);
                ctx.beginPath();
                ctx.moveTo(x, margin.top);
                ctx.lineTo(x, margin.top + chartHeight);
                ctx.stroke();
            }
            
            // Draw zero line
            if (minValue <= 0 && maxValue >= 0) {
                ctx.strokeStyle = '#999';
                ctx.lineWidth = 2;
                ctx.setLineDash([5, 5]);
                const zeroY = yScale(0);
                ctx.beginPath();
                ctx.moveTo(margin.left, zeroY);
                ctx.lineTo(margin.left + chartWidth, zeroY);
                ctx.stroke();
                ctx.setLineDash([]);
            }
            
            // Draw baseline line (red)
            if (baseline_cumulative && baseline_cumulative.length > 0) {
                ctx.strokeStyle = '#dc3545';
                ctx.lineWidth = 3;
                ctx.beginPath();
                for (let i = 0; i < baseline_cumulative.length; i++) {
                    const x = xScale(i);
                    const y = yScale(baseline_cumulative[i]);
                    if (i === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                }
                ctx.stroke();
                
                // Draw points
                ctx.fillStyle = '#dc3545';
                for (let i = 0; i < baseline_cumulative.length; i++) {
                    const x = xScale(i);
                    const y = yScale(baseline_cumulative[i]);
                    ctx.beginPath();
                    ctx.arc(x, y, 3, 0, 2 * Math.PI);
                    ctx.fill();
                }
            }
            
            // Draw optimized line (green)
            if (optimized_cumulative && optimized_cumulative.length > 0) {
                ctx.strokeStyle = '#28a745';
                ctx.lineWidth = 3;
                ctx.beginPath();
                for (let i = 0; i < optimized_cumulative.length; i++) {
                    const x = xScale(i);
                    const y = yScale(optimized_cumulative[i]);
                    if (i === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                }
                ctx.stroke();
                
                // Draw points
                ctx.fillStyle = '#28a745';
                for (let i = 0; i < optimized_cumulative.length; i++) {
                    const x = xScale(i);
                    const y = yScale(optimized_cumulative[i]);
                    ctx.beginPath();
                    ctx.arc(x, y, 3, 0, 2 * Math.PI);
                    ctx.fill();
                }
            }
            
            // Draw axes
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            ctx.beginPath();
            // Y-axis
            ctx.moveTo(margin.left, margin.top);
            ctx.lineTo(margin.left, margin.top + chartHeight);
            // X-axis
            ctx.moveTo(margin.left, margin.top + chartHeight);
            ctx.lineTo(margin.left + chartWidth, margin.top + chartHeight);
            ctx.stroke();
            
            // X-axis labels (show every few labels to avoid crowding)
            ctx.fillStyle = '#666';
            ctx.font = '10px Arial';
            ctx.textAlign = 'center';
            const labelStep = Math.max(1, Math.floor(labels.length / 8));
            for (let i = 0; i < labels.length; i += labelStep) {
                const x = xScale(i);
                ctx.fillText(labels[i], x, margin.top + chartHeight + 15);
            }
            
            // Chart title
            ctx.fillStyle = '#333';
            ctx.font = 'bold 16px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('So S√°nh PnL T√≠ch L≈©y (%)', width / 2, 20);
            
            // Final values display
            if (baseline_cumulative && baseline_cumulative.length > 0) {
                const finalBaseline = baseline_cumulative[baseline_cumulative.length - 1];
                ctx.fillStyle = '#dc3545';
                ctx.font = 'bold 12px Arial';
                ctx.textAlign = 'left';
                ctx.fillText(`G·ªëc: ${finalBaseline.toFixed(2)}%`, margin.left + chartWidth + 10, margin.top + 20);
            }
            
            if (optimized_cumulative && optimized_cumulative.length > 0) {
                const finalOptimized = optimized_cumulative[optimized_cumulative.length - 1];
                ctx.fillStyle = '#28a745';
                ctx.font = 'bold 12px Arial';
                ctx.textAlign = 'left';
                ctx.fillText(`T·ªëi ∆∞u: ${finalOptimized.toFixed(2)}%`, margin.left + chartWidth + 10, margin.top + 40);
                
                // Show improvement
                if (baseline_cumulative && baseline_cumulative.length > 0) {
                    const improvement = finalOptimized - baseline_cumulative[baseline_cumulative.length - 1];
                    ctx.fillStyle = improvement >= 0 ? '#28a745' : '#dc3545';
                    ctx.fillText(`C·∫£i thi·ªán: ${improvement >= 0 ? '+' : ''}${improvement.toFixed(2)}%`, margin.left + chartWidth + 10, margin.top + 60);
                }
            }
        }
    </script>
</body>
</html>
