<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Simulator</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
</head>
<body class="p-3">
  <div class="container">
    <h1>Trading Simulator</h1>
    <form id="sim-form" class="row g-3">
      <div class="col-md-3">
        <label class="form-label">Symbol</label>
        <input name="symbol" class="form-control" value="TEST">
      </div>
      <div class="col-md-3">
        <label class="form-label">Strategy</label>
        <input name="strategy" class="form-control" value="demo">
      </div>
      <div class="col-md-3">
        <label class="form-label">TP levels (comma %)</label>
        <input name="tp_levels" class="form-control" placeholder="1,2,5">
      </div>
      <div class="col-md-2">
        <label class="form-label">SL %</label>
        <input name="sl" class="form-control" value="-2">
      </div>
      <div class="col-md-2">
        <label class="form-label">Trailing stop %</label>
        <input name="trailing_stop" class="form-control" value="0">
      </div>
      <div class="col-md-2">
        <label class="form-label">BE trigger %</label>
        <input name="break_even_trigger" class="form-control" value="0">
      </div>
      <div class="col-md-2">
        <label class="form-label">BE SL %</label>
        <input name="break_even_sl" class="form-control" value="0">
      </div>
      <div class="col-12">
        <button class="btn btn-primary" type="submit">Run Simulation</button>
      </div>
    </form>

    <div id="warnings" class="mt-3"></div>

    <div class="mt-4">
      <canvas id="sim-chart" height="120"></canvas>
    </div>

    <div id="sim-preview" class="mt-4"></div>
  </div>

<script>
document.getElementById('sim-form').addEventListener('submit', async function(e){
  e.preventDefault();
  const form = e.target;
  const data = {
    symbol: form.symbol.value.trim(),
    strategy: form.strategy.value.trim(),
    tp_levels: form.tp_levels.value.split(',').map(s=>s.trim()).filter(Boolean),
    sl: parseFloat(form.sl.value || 0),
    trailing_stop: parseFloat(form.trailing_stop.value || 0),
    break_even_trigger: parseFloat(form.break_even_trigger.value || 0),
    break_even_sl: parseFloat(form.break_even_sl.value || 0)
  };

  const resp = await fetch('/simulate', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(data)});
  const body = await resp.json();
  if(!body.success){
    document.getElementById('warnings').innerText = 'Error: ' + (body.error || 'Unknown');
    return;
  }
  document.getElementById('warnings').innerText = '';

  // render chart
  const ctx = document.getElementById('sim-chart').getContext('2d');
  if(window._sim_chart) window._sim_chart.destroy();
  window._sim_chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: body.preview.map((p,i)=>p.date || i),
      datasets: [{label:'Cumulative PnL', data: body.cumulative, borderColor:'blue', tension:0.2}]
    },
    options: {scales:{y:{beginAtZero:false}}}
  });

  // preview
  const previewDiv = document.getElementById('sim-preview');
  let html = '<table class="table table-sm"><thead><tr><th>trade</th><th>date</th><th>entry</th><th>exit</th><th>pnl %</th><th>pnl</th><th>exit_reason</th></tr></thead><tbody>';
  for(const p of body.preview){
    html += `<tr><td>${p.trade||''}</td><td>${p.date||''}</td><td>${p.entry_price||''}</td><td>${p.exit_price||''}</td><td>${p.pnl_pct||''}</td><td>${p.pnl_value||''}</td><td>${p.exit_reason||''}</td></tr>`;
  }
  html += '</tbody></table>';
  previewDiv.innerHTML = html;
});
</script>
</body>
</html>