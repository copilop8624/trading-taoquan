<!DOCTYPE html>
<html>
<head>
    <title>Multi-Symbol Batch Processing</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        .card { background: white; padding: 20px; margin: 10px 0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .form-group { margin: 15px 0; }
        .btn { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .btn:hover { background: #0056b3; }
        .btn-success { background: #28a745; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-danger { background: #dc3545; }
        .symbol-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; }
        .symbol-card { padding: 10px; border: 2px solid #ddd; border-radius: 4px; cursor: pointer; text-align: center; }
        .symbol-card.selected { border-color: #007bff; background: #e7f3ff; }
        .progress-bar { width: 100%; height: 20px; background: #f0f0f0; border-radius: 10px; margin: 10px 0; }
        .progress-fill { height: 100%; background: #007bff; border-radius: 10px; transition: width 0.3s; }
        .status-indicator { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 5px; }
        .status-ready { background: #28a745; }
        .status-running { background: #ffc107; }
        .status-completed { background: #007bff; }
        .status-error { background: #dc3545; }
        .chart-container { height: 300px; margin: 20px 0; }
        select, input { padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 100%; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th, td { padding: 8px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background: #f8f9fa; }
        .navigation { text-align: center; margin: 20px 0; }
        .nav-link { color: #007bff; text-decoration: none; margin: 0 10px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="navigation">
            <a href="/" class="nav-link">üè† Home</a>
            <a href="/batch" class="nav-link">üìä Batch Processing</a>
            <a href="/compare" class="nav-link">üîç Compare Results</a>
            <a href="/analytics" class="nav-link">üìà Analytics</a>
        </div>

        <h1>üöÄ Multi-Symbol Batch Processing</h1>
        
        <div class="card">
            <h3>Batch Configuration</h3>
            <form id="batchForm">
                <div class="form-group">
                    <label>Select Symbols:</label>
                    <div class="symbol-grid" id="symbolGrid">
                        {% for symbol in available_symbols %}
                        <div class="symbol-card" data-symbol="{{symbol}}">
                            <strong>{{symbol}}</strong><br>
                            <small>Timeframes: {{available_timeframes.get(symbol, [])|join(', ')}}</small>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <div class="form-group">
                    <label>Optimization Method:</label>
                    <select id="optimizationMethod">
                        <option value="optuna">Optuna (Bayesian)</option>
                        <option value="grid">Grid Search</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Number of Trials:</label>
                    <input type="number" id="numTrials" value="100" min="10" max="1000">
                </div>

                <div class="form-group">
                    <label>Parallel Workers:</label>
                    <input type="number" id="parallelWorkers" value="4" min="1" max="8">
                </div>

                <div class="form-group">
                    <label>Timeout (minutes):</label>
                    <input type="number" id="timeout" value="60" min="5" max="480">
                </div>

                <button type="submit" class="btn">üöÄ Start Batch Optimization</button>
            </form>
        </div>

        <div class="card" id="batchStatus" style="display: none;">
            <h3>Batch Status</h3>
            <div id="overallProgress">
                <div class="progress-bar">
                    <div class="progress-fill" id="overallProgressFill"></div>
                </div>
                <p id="overallProgressText">Ready to start...</p>
            </div>

            <div id="symbolProgress"></div>
            
            <button class="btn btn-danger" onclick="stopBatch()">‚èπÔ∏è Stop Batch</button>
        </div>

        <div class="card">
            <h3>Recent Batch Results</h3>
            <div id="recentResults">
                {% if batch_history %}
                <table>
                    <thead>
                        <tr>
                            <th>Symbol</th>
                            <th>Timeframe</th>
                            <th>Best PnL</th>
                            <th>Win Rate</th>
                            <th>Max DD</th>
                            <th>Sharpe</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for result in batch_history[:10] %}
                        <tr>
                            <td>{{result.symbol}}</td>
                            <td>{{result.timeframe}}</td>
                            <td>${{result.total_pnl|round(2)}}</td>
                            <td>{{(result.win_rate*100)|round(1)}}%</td>
                            <td>{{(result.max_drawdown*100)|round(1)}}%</td>
                            <td>{{result.sharpe_ratio|round(2)}}</td>
                            <td>{{result.timestamp.strftime('%Y-%m-%d %H:%M')}}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p>No batch results yet. Start your first batch optimization!</p>
                {% endif %}
            </div>
        </div>

        <div class="card">
            <h3>Performance Overview</h3>
            <div class="chart-container">
                <canvas id="performanceChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        let selectedSymbols = [];
        let currentBatchId = null;
        let statusInterval = null;

        // Symbol selection
        document.querySelectorAll('.symbol-card').forEach(card => {
            card.addEventListener('click', function() {
                const symbol = this.dataset.symbol;
                if (this.classList.contains('selected')) {
                    this.classList.remove('selected');
                    selectedSymbols = selectedSymbols.filter(s => s !== symbol);
                } else {
                    this.classList.add('selected');
                    selectedSymbols.push(symbol);
                }
            });
        });

        // Form submission
        document.getElementById('batchForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (selectedSymbols.length === 0) {
                alert('Please select at least one symbol');
                return;
            }

            const config = {
                symbols: selectedSymbols,
                optimization_method: document.getElementById('optimizationMethod').value,
                num_trials: parseInt(document.getElementById('numTrials').value),
                parallel_workers: parseInt(document.getElementById('parallelWorkers').value),
                timeout_minutes: parseInt(document.getElementById('timeout').value)
            };

            startBatchOptimization(config);
        });

        async function startBatchOptimization(config) {
            try {
                const response = await fetch('/batch_optimize', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(config)
                });

                const result = await response.json();
                
                if (result.success) {
                    currentBatchId = result.batch_id;
                    document.getElementById('batchStatus').style.display = 'block';
                    startStatusPolling();
                } else {
                    alert('Error starting batch: ' + result.message);
                }
            } catch (error) {
                alert('Network error: ' + error.message);
            }
        }

        function startStatusPolling() {
            statusInterval = setInterval(updateBatchStatus, 2000);
        }

        async function updateBatchStatus() {
            if (!currentBatchId) return;

            try {
                const response = await fetch(`/batch_status/${currentBatchId}`);
                const status = await response.json();

                // Update overall progress
                const progressFill = document.getElementById('overallProgressFill');
                const progressText = document.getElementById('overallProgressText');
                
                progressFill.style.width = status.overall_progress + '%';
                progressText.textContent = `${status.overall_progress.toFixed(1)}% - ${status.status}`;

                // Update symbol progress
                const symbolProgress = document.getElementById('symbolProgress');
                symbolProgress.innerHTML = '';

                status.symbol_progress.forEach(symbol => {
                    const symbolDiv = document.createElement('div');
                    symbolDiv.innerHTML = `
                        <h4><span class="status-indicator status-${symbol.status}"></span>${symbol.symbol}</h4>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${symbol.progress}%"></div>
                        </div>
                        <p>${symbol.current_trial}/${symbol.total_trials} trials - Best PnL: $${symbol.best_pnl}</p>
                    `;
                    symbolProgress.appendChild(symbolDiv);
                });

                // Stop polling if completed
                if (status.status === 'completed' || status.status === 'failed') {
                    clearInterval(statusInterval);
                    if (status.status === 'completed') {
                        location.reload(); // Refresh to show new results
                    }
                }
            } catch (error) {
                console.error('Error updating status:', error);
            }
        }

        function stopBatch() {
            if (currentBatchId && confirm('Are you sure you want to stop the batch?')) {
                // Implementation for stopping batch
                clearInterval(statusInterval);
                currentBatchId = null;
                document.getElementById('batchStatus').style.display = 'none';
            }
        }

        // Initialize performance chart
        const ctx = document.getElementById('performanceChart').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: {{available_symbols|tojson}},
                datasets: [{
                    label: 'Best PnL',
                    data: {% if batch_history %}{{batch_history[:len(available_symbols)]|map(attribute='total_pnl')|list|tojson}}{% else %}[]{% endif %},
                    backgroundColor: 'rgba(54, 162, 235, 0.6)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: 'PnL ($)' }
                    }
                }
            }
        });
    </script>
</body>
</html>