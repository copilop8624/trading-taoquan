[BỔ SUNG QUAN TRỌNG - PHẢI CHECK THỦ CÔNG KHI MÔ PHỎNG/ĐỐI CHIẾU TRADE]
1. LUÔN kiểm tra lại timestamp của trade và nến (candle) đã khớp chưa, đã chuẩn hóa (normalize) chưa, tránh lệch 1 nến hoặc lệch index.
2. Khi mô phỏng thủ công, phải so sánh từng bước với log/code, đảm bảo trade mở/đóng đúng nến, đúng timestamp, đúng giá trị.
3. Nếu có nghi ngờ lệch nến, lệch timestamp, phải dừng lại kiểm tra lại dữ liệu gốc và log mô phỏng.
4. Ghi chú lại mọi trường hợp lệch timestamp/index để cập nhật code hoặc checklist.
5. Khi kiểm tra lại code, phải tìm và xác nhận mọi chỗ có xử lý timestamp/index đều đã chuẩn hóa và log rõ ràng.
# Checklist mô phỏng thủ công lệnh trading (manual backtest)
# [CẢNH BÁO BỔ SUNG 2025-07-25]
# - Luôn chuẩn hóa timestamp (tz-naive/tz-aware) giữa lệnh và dữ liệu nến, đối chiếu đúng vùng nến thực tế.
# - Không được lấy nhầm nến entry/exit, không được lệch múi giờ hoặc format.
# - Luôn log từng nến, từng bước update trạng thái, đặc biệt sau khi trailing SL/BE/TS kích hoạt.
# - Mô phỏng đúng thứ tự giá chạy trong nến, không chỉ kiểm tra high/low một lần.
# - Nếu tool gốc chỉ lấy index hoặc không chuẩn hóa timestamp, phải sửa ngay để tránh sai sót tương tự.
# CẢNH BÁO: Nếu bỏ qua bất kỳ bước nào hoặc không log đủ từng nến thực tế, kết quả mô phỏng có thể SAI NGHIÊM TRỌNG. KHÔNG được kết luận PnL nếu không đủ data thực tế từng nến.

## 1. Quy trình chuẩn từng nến
- [ ] Sau entry, duyệt từng nến liên tục cho đến khi lệnh đóng.
- [ ] Ở mỗi nến:
    - [ ] Kiểm tra giá LOW (LONG) hoặc HIGH (SHORT) <=/>= SL hiện tại → đóng lệnh tại SL.
    - [ ] Nếu chưa bị SL, kiểm tra giá HIGH (LONG) hoặc LOW (SHORT) >=/<= BE trigger → kích hoạt BE, dời SL về entry.
    - [ ] Nếu chưa bị SL, kiểm tra giá HIGH (LONG) hoặc LOW (SHORT) >=/<= TS trigger → kích hoạt trailing, trailing SL = đỉnh/đáy mới nhất × (1 -/+ step%).
    - [ ] Nếu trailing đang active, mỗi khi có đỉnh/đáy mới, trailing SL sẽ dời lên/xuống.
    - [ ] NGAY SAU KHI trailing SL được cập nhật, kiểm tra giá LOW (LONG) hoặc HIGH (SHORT) của nến hiện tại và các nến tiếp theo, nếu chạm thì đóng lệnh ngay tại trailing SL (hoặc giá LOW/HIGH nếu thấp/hơn hơn).
- [ ] Nếu không bị cắt, lệnh đóng tại giá close cuối cùng.

## 2. Các sai lầm từng gặp (liên tục cập nhật)
# [2025-07-25] Đã từng bị lệch nến do không chuẩn hóa timestamp, dẫn đến tính sai PnL hoặc bỏ sót trigger BE/TS/trailing SL.
- [x] Không log từng nến, bỏ qua cập nhật trailing SL liên tục.
- [x] Không kiểm tra giá LOW/HIGH từng nến sau khi trailing SL được nâng lên.
- [x] Chỉ tính PnL tại giá close cuối mà không xét khả năng bị cắt sớm bởi trailing SL.
- [x] Không kiểm tra giá LOW/HIGH ngay sau khi trailing SL được cập nhật, dẫn đến bỏ sót điểm cắt lệnh thực tế.
- [x] Tự giả lập data hoặc tóm tắt thay vì dùng data thực tế từng nến khi đã có file data.
- [x] Không dừng lại yêu cầu thêm data khi thiếu, mà tự suy diễn tiếp.
- [ ] (Cập nhật thêm nếu phát hiện sai lầm mới)


## 3. Cơ chế tránh sai lầm & RÀNG BUỘC TRÁCH NHIỆM
- Luôn tham chiếu checklist này trước khi mô phỏng thủ công.
- KHÔNG được phép kết luận PnL nếu không log đủ từng nến thực tế từ file data.
- Khi trả lời mô phỏng thủ công, phải log rõ từng nến, cập nhật trạng thái BE/TS/trailing SL liên tục, kiểm tra giá LOW/HIGH ngay sau khi trailing SL được cập nhật.
- Nếu thiếu data, phải yêu cầu bổ sung, không tự giả lập.
- Nếu phát hiện sai lầm mới, bổ sung ngay vào mục 2.
- Định kỳ tự kiểm tra lại checklist khi làm việc với các lệnh backtest thủ công.
- Nếu vi phạm checklist (bị phát hiện hoặc tự phát hiện), PHẢI tự động log lại toàn bộ quy trình, nhận sai sót, không được tiếp tục trả lời sai hoặc kết luận PnL sai. Cảnh báo hậu quả: mọi sai sót đều có thể gây thiệt hại lớn cho người dùng.

---
Checklist này sẽ được cập nhật liên tục để hoàn thiện quy trình và tránh lặp lại sai lầm cũ.
